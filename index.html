<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Profesional de Análisis de Riesgos | ISO 27005</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/timdream/wordcloud2.js/src/wordcloud2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .widget { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #ef4444; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button { padding: 0.75rem 1.5rem; border-bottom: 4px solid transparent; transition: all 0.3s ease; font-weight: 500; color: #4b5563; }
        .tab-button.active { border-color: #ef4444; color: #ef4444; font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .kpi-value { font-size: 2.5rem; }
        .heatmap-table { border-collapse: collapse; }
        .heatmap-cell { border: 1px solid #ddd; padding: 0.5rem; text-align: center; width: 60px; height: 60px; }
        .heatmap-cell span { font-size: 1.5rem; font-weight: bold; color: black; text-shadow: 0 0 2px white; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="password-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Acceso de Administrador</h2>
            <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Contraseña">
            <button id="password-submit" class="w-full mt-4 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">Ingresar</button>
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Contraseña incorrecta.</p>
        </div>
    </div>

    <div id="dashboard-content" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center space-x-4">
                <img src="https://logodownload.org/wp-content/uploads/2014/09/coca-cola-logo-1.png" alt="Logo" class="h-10">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard Profesional de Análisis de Riesgos</h1>
            </div>
            <div>
                <button id="refresh-data-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 mr-4">Actualizar Datos</button>
                <button id="export-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 disabled:opacity-50" disabled>Exportar a PDF</button>
            </div>
        </header>

        <main class="p-4 sm:p-8">
            <div id="loading-container" class="widget text-center py-10">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-600">Conectando con Google Sheets...</p>
            </div>

            <div id="analytics-section" class="hidden">
                <div class="widget mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Filtros Globales (Segmentación de Datos)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label for="filter-gerencia" class="block text-sm font-medium text-gray-600">Centro de Distribución</label><select id="filter-gerencia" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></select></div>
                        <div><label for="filter-antiguedad" class="block text-sm font-medium text-gray-600">Años de Antigüedad</label><select id="filter-antiguedad" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></select></div>
                        <div><label for="filter-sexo" class="block text-sm font-medium text-gray-600">Género</label><select id="filter-sexo" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></select></div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md mb-8">
                    <nav id="tabs-nav" class="flex flex-wrap border-b border-gray-200">
                        <button class="tab-button active" data-tab="tab-principal">Dashboard Principal</button>
                        <button class="tab-button" data-tab="tab-estrategico">Análisis Estratégico</button>
                        <button class="tab-button" data-tab="tab-preguntas">Análisis por Pregunta</button>
                        <button class="tab-button" data-tab="tab-cualitativo">Análisis Cualitativo</button>
                        <button class="tab-button" data-tab="tab-datos">Datos Crudos</button>
                    </nav>
                </div>
                
                <div id="tabs-content">
                    <div id="tab-principal" class="tab-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                            <div class="widget text-center"><h3 class="text-base font-semibold text-gray-500">Total de Respuestas</h3><p id="kpi-total-respuestas" class="kpi-value font-bold text-red-600 mt-2">0</p></div>
                            <div class="widget text-center"><h3 class="text-base font-semibold text-gray-500">Madurez General</h3><p id="kpi-madurez-promedio" class="kpi-value font-bold text-red-600 mt-2">0.0/5</p></div>
                            <div class="widget text-center"><h3 class="text-base font-semibold text-gray-500">Nivel de Concienciación</h3><p id="kpi-awareness-level" class="kpi-value font-bold text-blue-600 mt-2">0%</p></div>
                            <div class="widget text-center"><h3 class="text-base font-semibold text-gray-500">Eficacia de Controles</h3><p id="kpi-control-effectiveness" class="kpi-value font-bold text-green-600 mt-2">0%</p></div>
                            <div class="widget text-center"><h3 class="text-base font-semibold text-gray-500">Dominio más Fuerte</h3><p id="kpi-dominio-fuerte" class="text-xl font-bold text-gray-800 mt-3 break-words">N/A</p></div>
                        </div>
                        <div class="widget mb-8">
                            <h3 class="text-xl font-semibold mb-2 text-gray-700">Rúbrica de Indicadores Clave (KPIs)</h3>
                            <div id="kpi-rubric-text" class="text-sm text-gray-600 space-y-2"></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="widget lg:col-span-3">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Nivel de Madurez por Dominio (ISO 27005)</h3>
                                <div class="relative h-96">
                                    <canvas id="maturity-radar-chart"></canvas>
                                </div>
                                <div id="maturity-radar-analysis" class="mt-4 text-sm text-gray-600"></div>
                            </div>
                            <div class="widget lg:col-span-2">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Perfil Demográfico</h3>
                                <div class="relative h-96">
                                    <canvas id="gender-pie-chart"></canvas>
                                </div>
                                <div id="gender-pie-analysis" class="mt-4 text-sm text-gray-600"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-estrategico" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="widget">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Matriz de Riesgo</h3>
                                <p class="text-sm text-gray-500 mb-4">Posicionamiento del riesgo organizacional basado en la fortaleza de los controles (Probabilidad) y la criticidad de los activos (Impacto).</p>
                                <div id="heatmap-container" class="flex justify-center items-center mt-6"></div>
                            </div>
                             <div class="widget">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Plan de Acción Sugerido</h3>
                                <p class="text-sm text-gray-500 mb-4">Dominios con el puntaje más bajo y recomendaciones estratégicas para enfocar los esfuerzos de mejora.</p>
                                <div id="recommendations-container" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-preguntas" class="tab-content">
                        <div class="widget">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Análisis Detallado por Pregunta</h3>
                            <select id="question-selector" class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg mb-4"></select>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                                <div class="h-96"><canvas id="question-detail-chart"></canvas></div>
                                <div>
                                    <h4 class="font-semibold text-lg mb-2">Análisis de Resultados</h4>
                                    <div id="question-detail-analysis" class="text-sm text-gray-700 space-y-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-cualitativo" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="widget">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Nube de Palabras Clave</h3>
                                <p class="text-sm text-gray-500 mb-4">Temas más frecuentes mencionados en los comentarios abiertos.</p>
                                <div class="w-full h-96 flex items-center justify-center">
                                    <canvas id="word-cloud-canvas" width="400" height="400"></canvas>
                                </div>
                            </div>
                            <div class="widget">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Comentarios y Oportunidades</h3>
                                <input type="text" id="comment-search" class="w-full p-2 border border-gray-300 rounded-lg mb-4" placeholder="Buscar en comentarios...">
                                <div class="max-h-96 overflow-y-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentario Adicional (q46)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Oportunidad de Mejora (q47)</th></tr></thead>
                                        <tbody id="comments-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-datos" class="tab-content">
                        <div class="widget">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Datos Crudos de Google Sheet</h3>
                            <div class="max-h-[600px] overflow-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead id="raw-data-head" class="bg-gray-50 sticky top-0"></thead>
                                    <tbody id="raw-data-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    const ADMIN_PASSWORD = 'maestria2025';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5jkSpifIgE40-RxsnIjQsDue0MluN6HcB8rSFwRoEp_xQBWHSf8bPjBE-pqF44cD82A/exec';

    document.getElementById('password-submit').addEventListener('click', () => {
        const input = document.getElementById('password-input');
        if (input.value === ADMIN_PASSWORD) {
            document.getElementById('password-overlay').style.display = 'none';
            document.getElementById('dashboard-content').classList.remove('hidden');
            loadData();
        } else {
            document.getElementById('password-error').classList.remove('hidden');
            input.value = '';
        }
    });

    const loadingContainer = document.getElementById('loading-container');
    const loadingText = document.getElementById('loading-text');
    const analyticsSection = document.getElementById('analytics-section');
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const refreshBtn = document.getElementById('refresh-data-btn');
    
    let allData = [];
    let charts = {};
    
    refreshBtn.addEventListener('click', loadData);

    async function loadData() {
        if (SCRIPT_URL.includes('PEGA_AQUI')) {
            loadingText.innerHTML = `<span class="text-red-600 font-semibold">Error de Configuración:<br>Edita este archivo HTML y actualiza la variable SCRIPT_URL.</span>`;
            return;
        }
        analyticsSection.classList.add('hidden');
        loadingContainer.classList.remove('hidden');
        loadingText.textContent = 'Actualizando datos desde Google Sheets...';

        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
            const data = await response.json();
            if (data.error) throw new Error(`Error en el script: ${data.error}`);
            
            allData = data;
            loadingContainer.classList.add('hidden');
            analyticsSection.classList.remove('hidden');
            exportPdfBtn.disabled = false;
            
            initializeDashboard();

        } catch (error) {
            console.error("Error al cargar los datos:", error);
            loadingText.innerHTML = `<span class="text-red-600 font-semibold">Error al Cargar Datos:<br>Verifica la URL del script, los permisos en Google Sheets y tu conexión.<br><small>${error.message}</small></span>`;
        }
    }

    const domainMapping = {"Conocimiento General de Políticas":{"start":4,"end":5},"Contexto organizacional y activos":{"start":6,"end":12},"Identificación de amenazas y vulnerabilidades":{"start":13,"end":18},"Evaluación del riesgo":{"start":19,"end":25},"Tratamiento del riesgo":{"start":26,"end":31},"Comunicación y concienciación":{"start":32,"end":37},"Monitoreo y mejora continua":{"start":38,"end":45}};
    const questionLabels = {"q4":"4. ¿Considera que la organización cuenta con alguna política de riesgo?","q5":"5. ¿Conoce las políticas de riesgo?","q6":"6. ¿Considera que la organización tiene mapeado sus diferentes activos de información correspondientes a TI identificando sus activos críticos y no críticos?","q7":"7. ¿Dentro de la organización existe un inventario actualizado de activos de TI y sistemas de información?","q8":"8. ¿Considera que existen lineamientos definidos dentro de la organización para la clasificación de activos (hardware, software, personas, información digital, información física, instalaciones, servicios)?","q9":"9. ¿Dentro de la organización los activos de información (hardware, software, información física, digital, etc.) cuentan con responsables formalmente asignados?","q10":"10. ¿Considera que existen criterios de clasificación de la información dentro de la organización (confidencial, interna, pública, secreta y restringida)?","q11":"11. ¿Considera que se revisa periódicamente la criticidad de los activos frente a los objetivos de la organización?","q12":"12. ¿En su opinión sobre los riesgos identificados dentro de la organización, considera que es escuchada y valorada?","q13":"13. ¿Dentro de la organización se identifica de manera sistemática las amenazas que pueden afectar la información (fraude, ciberataques, sabotaje, errores humanos)?","q14":"14. ¿Cree usted que se mantienen registros de vulnerabilidades técnicas detectadas en los sistemas (parches, software desactualizado, malas configuraciones)?","q15":"15. ¿Considera que los empleados son conscientes de las amenazas relacionadas con el mal uso de la información?","q16":"16. ¿Cree que se evalúan riesgos derivados de proveedores y terceros?","q17":"17. ¿Cree usted que existe una acción preventiva contra el riesgo de insiders dentro de la organización?","q18":"18. ¿Está usted de acuerdo que la organización realiza ejercicios de simulación de incidentes para identificar debilidades?","q19":"19. ¿Cree que existe una metodología formal para evaluar riesgos de seguridad de la información?","q20":"20. ¿Considera Usted que existe una metodología definida para evaluar la probabilidad e impacto de los riesgos?","q21":"21. ¿Considera que se priorizan los riesgos de acuerdo con su criticidad para la continuidad de la organización?","q22":"22. ¿Cree que las decisiones estratégicas de la organización tienen en cuenta los riesgos relevantes de confidencialidad, disponibilidad y seguridad de la información?","q23":"23. ¿Cree que la organización revisa por lo menos, una vez al año, la matriz de riesgos con el fin de actualizarla?","q24":"24. ¿Considera que en la organización se contemplan riesgos emergentes (ej. inteligencia artificial, IoT, nube)?","q25":"25. ¿Considera que los riesgos regulatorios y legales forman parte del análisis de riesgos de seguridad de la información?","q26":"26. ¿Cree usted que la organización define claramente las estrategias de tratamiento de riesgos (mitigar, transferir, aceptar, evitar)?","q27":"27. ¿Considera que se asignan responsables específicos para los planes de acción de los riesgos críticos identificados?","q28":"28. ¿Considera que los planes de tratamiento son revisados conforme a lo establecido en la organización y se ajustan según cambios en el entorno?","q29":"29. ¿Considera que se destina presupuesto específico para prevenir los riesgos de seguridad?","q30":"30. ¿Está usted de acuerdo que los responsables de riesgos reporten periódicamente el estado de los planes a la dirección?","q31":"31. ¿Considera usted que la organización contrate seguros con coberturas para riesgos de ciberseguridad?","q32":"32. ¿Considera que la organización comunica los riesgos de seguridad de la información a todos los niveles?","q33":"33. ¿Cree que existen capacitaciones periódicas en gestión de riesgos y ciberseguridad?","q34":"34. ¿Cree que la alta dirección participa activamente en la toma de decisiones sobre riesgos de seguridad de la información?","q35":"35. ¿Considera usted que los empleados conocen a quién reportar un incidente de seguridad?","q36":"36. ¿Cree que se promueve una cultura de “seguridad como responsabilidad compartida”?","q37":"37. ¿Considera que los mensajes de concienciación (ej. phishing, contraseñas seguras) son frecuentes y claros?","q38":"38. ¿Cree Usted que los riesgos se monitorean de manera continua con apoyo de herramientas tecnológicas (ej. SIEM, EDR, monitoreo en tiempo real)?","q39":"39. ¿Cree que se documentan y analizan los incidentes de seguridad ocurridos en la organización?","q40":"40. ¿Considera usted que existen auditorías o revisiones periódicas para verificar la eficacia de los controles implementados?","q41":"41. ¿Cree que se aplican indicadores de desempeño (KPI/KRI) para evaluar el sistema de gestión de riesgos?","q42":"42. ¿Cree Usted que los resultados de auditorías internas son compartidos con la alta dirección?","q43":"43. ¿Considera usted que se toman en cuenta registros históricos, o lecciones aprendidas en el análisis de los riesgos?","q44":"44. ¿Considera que la organización evalúa periódicamente la eficacia de sus controles frente a riesgos de seguridad de la información?","q45":"45. ¿Cree que los riesgos derivados de proveedores y terceros son gestionados y monitoreados regularmente?"};
    
    const expertInterpretations = {
        q4: (p) => {
            const positive = p[4] + p[5];
            if (positive >= 40) {
                 return `Con base a los análisis, se observó que el <strong>${positive.toFixed(1)}%</strong> de los colaboradores (<strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y <strong>${p[5].toFixed(1)}%</strong> 'Totalmente de acuerdo') consideran que la empresa sí cuenta con una política de riesgo. Sin embargo, se identificó que un <strong>${p[2].toFixed(1)}%</strong> está "En Desacuerdo" y un <strong>${p[3].toFixed(1)}%</strong> se encuentra en postura "Neutral". Esto sugiere que la política de riesgo no alcanza los niveles de comunicación deseados.`;
            } else if (p[3] > 40) {
                return `El hallazgo principal es la incertidumbre, con un <strong>${p[3].toFixed(1)}%</strong> en postura "Neutral". Esto indica que la mayoría del personal desconoce si existen políticas. Aunque un <strong>${positive.toFixed(1)}%</strong> cree que sí existen, la falta de certeza en un grupo tan grande es una falla de comunicación crítica que debe ser abordada.`;
            } else {
                return `La percepción sobre la existencia de políticas de riesgo es dividida y preocupante. Solo un <strong>${positive.toFixed(1)}%</strong> tiene una visión afirmativa, mientras que un <strong>${(p[1]+p[2]).toFixed(1)}%</strong> está en desacuerdo. El <strong>${p[3].toFixed(1)}%</strong> en "Neutral" agrava la situación, demostrando que la gobernanza de riesgos no está comunicada eficazmente.`;
            }
        },
        q5: (p) => {
            const positive = p[4] + p[5];
            const negative = p[1] + p[2];
            if (positive > 40) {
                return `Los resultados indican que el conocimiento de las políticas es aceptable, con un <strong>${positive.toFixed(1)}%</strong> de los encuestados (<strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y <strong>${p[5].toFixed(1)}%</strong> 'Totalmente de acuerdo') afirmando conocerlas. Aún así, el <strong>${p[3].toFixed(1)}%</strong> en 'Neutral' y el <strong>${negative.toFixed(1)}%</strong> en desacuerdo confirman que la comunicación puede ser mejorada.`;
            } else {
                return `Los resultados indican una brecha crítica entre la existencia de políticas y su conocimiento efectivo. Un alarmante <strong>${negative.toFixed(1)}%</strong> admite no conocerlas, y un <strong>${p[3].toFixed(1)}%</strong> se posiciona en 'Neutral', lo que en seguridad equivale a un "no sé". Apenas un <strong>${positive.toFixed(1)}%</strong> afirma conocerlas, confirmando una deficiencia sistémica en la comunicación.`;
            }
        },
        q6: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los colaboradores indica que hay confianza en que se tienen mapeados los activos críticos y no críticos. Sin embargo, el <strong>${(p[1]+p[2]).toFixed(1)}%</strong> 'En Desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> en 'Neutral' sugieren que el inventario de activos de información puede ser incompleto, probablemente centrado en infraestructura de TI tradicional mientras se omiten activos de datos no estructurados o propiedad intelectual.`,
        q7: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de colaboradores muestra una percepción positiva del inventario actualizado de activos. Por otro lado, un <strong>${(p[1]+p[2]).toFixed(1)}%</strong> expresa desacuerdo, indicando que no se consideran todos los activos. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' puede indicar que no han sido partícipes en la elaboración del inventario.`,
        q8: (p) => `Un <strong>${p[3].toFixed(1)}%</strong> de colaboradores se mantiene 'Neutral' y un <strong>${(p[1]+p[2]).toFixed(1)}%</strong> está en desacuerdo, lo que puede indicar falta de conocimiento sobre los lineamientos de clasificación. Sin embargo, un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> muestra una percepción positiva de que conoce los lineamientos.`,
        q9: (p) => `Con un <strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y un <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo', se refleja una división de opiniones sobre la asignación de responsables de activos. El <strong>${p[3].toFixed(1)}%</strong> en 'Neutral' indica un desconocimiento generalizado sobre este punto crucial de gobernanza.`,
        q10: (p) => `El <strong>${(p[4] + p[5]).toFixed(1)}%</strong> muestra una percepción positiva sobre la existencia de criterios de clasificación. No obstante, un <strong>${(p[1]+p[2]).toFixed(1)}%</strong> en desacuerdo y un significativo <strong>${p[3].toFixed(1)}%</strong> 'Neutral' evidencian una posible ausencia o mala comunicación de dichos criterios.`,
        q11: (p) => `Existe una clara división de opiniones, con un <strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y un <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo'. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' sugiere que a una parte importante del personal no se le comunica o no participa en la revisión de la criticidad de los activos.`,
        q12: (p) => `Mientras un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> siente que su opinión es valorada, un preocupante <strong>${p[2].toFixed(1)}%</strong> está 'En desacuerdo'. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' refuerza la idea de que no se está fomentando un canal de comunicación efectivo para que los colaboradores reporten riesgos.`,
        q13: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> percibe que las amenazas se identifican sistemáticamente. Sin embargo, un <strong>${p[2].toFixed(1)}%</strong> está 'En desacuerdo' y un <strong>${p[3].toFixed(1)}%</strong> es 'Neutral', lo que indica que el proceso de identificación de amenazas no es transparente ni conocido por una gran parte de la organización.`,
        q14: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes muestra una percepción positiva. Por otro lado, un <strong>${p[2].toFixed(1)}%</strong> expresa desacuerdo. El <strong>${p[3].toFixed(1)}%</strong> restante en 'Neutral' indica indiferencia o falta de conocimiento sobre la existencia de registros de vulnerabilidades.`,
        q15: (p) => `Solo un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> se considera consciente de las amenazas por mal uso de información. El <strong>${p[2].toFixed(1)}%</strong> en 'Desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' sugieren una falta de concienciación crítica que puede llevar a incidentes por error humano.`,
        q16: (p) => `Las opiniones están divididas, con un <strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y un <strong>${p[3].toFixed(1)}%</strong> 'Neutral'. Esto indica que la evaluación de riesgos de terceros no es un proceso estandarizado ni comunicado. Un <strong>${p[2].toFixed(1)}%</strong> cree que directamente no se evalúan.`,
        q17: (p) => `Un <strong>${p[2].toFixed(1)}%</strong> 'En Desacuerdo' y un <strong>${p[3].toFixed(1)}%</strong> 'Neutral' (sumando más de la mitad) creen que no existen o desconocen acciones preventivas contra amenazas internas (insiders), lo cual es una brecha de seguridad importante. Solo un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> percibe lo contrario.`,
        q18: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los encuestados muestra una percepción positiva. Por otro lado, un <strong>${p[2].toFixed(1)}%</strong> se expresa 'En desacuerdo' de que se realicen simulacros. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' puede indicar que los ejercicios no involucran a todo el personal.`,
        q19: (p) => `Existe una división de opiniones con un <strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y un <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo'. El alto porcentaje de <strong>${p[3].toFixed(1)}%</strong> 'Neutral' indica una falta de conocimiento sobre la existencia de una metodología formal para evaluar riesgos.`,
        q20: (p) => `Con un <strong>${p[2].toFixed(1)}%</strong> 'En Desacuerdo' y un <strong>${p[3].toFixed(1)}%</strong> 'Neutral', hay una clara indicación de que la metodología de evaluación de impacto y probabilidad no es conocida o no existe formalmente. Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> cree que sí existe.`,
        q21: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes percibe positivamente la priorización de riesgos. Sin embargo, un <strong>${p[2].toFixed(1)}%</strong> está 'En Desacuerdo' y un <strong>${p[3].toFixed(1)}%</strong> es 'Neutral', indicando que el proceso no es transparente para todos.`,
        q22: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> cree que las decisiones estratégicas consideran los riesgos de seguridad. Por otro lado, un <strong>${p[2].toFixed(1)}%</strong> está 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' sugiere que esta alineación entre seguridad y estrategia no es evidente para una gran parte del equipo.`,
        q23: (p) => `Un <strong>${p[2].toFixed(1)}%</strong> expresa 'En desacuerdo' sobre la revisión anual de la matriz de riesgos, superando al <strong>${(p[4] + p[5]).toFixed(1)}%</strong> que está de acuerdo. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' podría indicar que el proceso se realiza sin la debida comunicación.`,
        q24: (p) => `Aunque un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> tiene una percepción positiva, el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' y el <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' muestran que la consideración de riesgos emergentes como IA o IoT no es una práctica conocida o estandarizada.`,
        q25: (p) => `Hay una fuerte división de opiniones: <strong>${p[4].toFixed(1)}%</strong> 'De acuerdo' y <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo'. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' indica que el personal no tiene claro si los análisis de riesgos de seguridad incluyen el componente regulatorio y legal.`,
        q26: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> percibe que las estrategias de tratamiento están bien definidas. No obstante, el <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' apuntan a posibles inconsistencias en la aplicación o comunicación de dichas estrategias.`,
        q27: (p) => `Solo un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> cree que se asignan responsables para los planes de acción. Un <strong>${p[2].toFixed(1)}%</strong> opina lo contrario y un <strong>${p[3].toFixed(1)}%</strong> lo desconoce, lo que sugiere una falta de rendición de cuentas (accountability).`,
        q28: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> muestra una percepción positiva sobre la revisión de los planes de tratamiento. El <strong>${p[2].toFixed(1)}%</strong> que está 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' pueden indicar que no hay comunicación a todo nivel sobre estos ajustes.`,
        q29: (p) => `Aunque un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes muestra una percepción positiva, la suma del <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' refleja una fuerte incertidumbre sobre si se destina presupuesto específico para seguridad.`,
        q30: (p) => `Un preocupante <strong>${p[2].toFixed(1)}%</strong> está 'En desacuerdo' con que los responsables reporten a la dirección. Sumado al <strong>${p[3].toFixed(1)}%</strong> 'Neutral', esto indica una falta de visibilidad y gobernanza en el seguimiento de los planes de riesgo, a pesar del <strong>${(p[4] + p[5]).toFixed(1)}%</strong> que opina positivamente.`,
        q31: (p) => `Un <strong>${(p[1] + p[2]).toFixed(1)}%</strong> expresa desacuerdo con la contratación de ciberseguros, superando al <strong>${(p[4] + p[5]).toFixed(1)}%</strong> que está de acuerdo. El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' sugiere que la estrategia de transferencia de riesgos no es conocida por el personal.`,
        q32: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> percibe que la comunicación de riesgos es efectiva. Sin embargo, un <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y un <strong>${p[3].toFixed(1)}%</strong> 'Neutral' indican que la comunicación no está llegando a todos los niveles de la organización.`,
        q33: (p) => `Un alto <strong>${p[3].toFixed(1)}%</strong> se mantiene 'Neutral' y un <strong>${p[2].toFixed(1)}%</strong> está 'En desacuerdo', lo que indica que una mayoría no percibe o no participa en capacitaciones periódicas. Solo un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> tiene una percepción positiva.`,
        q34: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> percibe un involucramiento activo de la alta dirección. El <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' pueden indicar que este liderazgo no es visible para todos los empleados.`,
        q35: (p) => `El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' y el <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' suman una mayoría, lo que sugiere que el procedimiento para reportar un incidente no es claro para gran parte del personal, a pesar de que un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> afirma conocerlo.`,
        q36: (p) => `Se observa que un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes muestra una percepción positiva. Un <strong>${p[2].toFixed(1)}%</strong> expresa 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> restante 'Neutral', lo que puede indicar desconocimiento sobre la promoción de una cultura de seguridad compartida.`,
        q37: (p) => `El <strong>${p[3].toFixed(1)}%</strong> 'Neutral' y el <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' indican que los mensajes de concienciación no están siendo efectivos o no son atendidos por una mayoría. Solo un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> los considera claros y frecuentes.`,
        q38: (p) => `Un <strong>${p[2].toFixed(1)}%</strong> de los encuestados está 'En desacuerdo' con que los riesgos se monitorean con herramientas tecnológicas. Este grupo, junto con el <strong>${p[3].toFixed(1)}%</strong> 'Neutral', supera al <strong>${(p[4] + p[5]).toFixed(1)}%</strong> que tiene una percepción positiva, sugiriendo una falta de visibilidad en el monitoreo.`,
        q39: (p) => `Un <strong>${p[2].toFixed(1)}%</strong> ('En desacuerdo') y un <strong>${p[3].toFixed(1)}%</strong> ('Neutral') superan al <strong>${(p[4] + p[5]).toFixed(1)}%</strong> positivo. Esto indica que el proceso de análisis post-incidente no es transparente o no se comunica adecuadamente.`,
        q40: (p) => `Aunque un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> percibe que existen auditorías, el <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' sugieren que los resultados y la existencia de estas revisiones no son bien conocidos en toda la organización.`,
        q41: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> muestra una percepción positiva sobre el uso de KPIs/KRIs. Sin embargo, el <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' indican una posible inconsistencia en su aplicación o comunicación.`,
        q42: (p) => `El <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> 'Neutral' suman una mayoría, lo que indica que los empleados no perciben que los resultados de las auditorías se compartan con la alta dirección, señalando una posible falla en la gobernanza. Solo un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> cree que sí se comparten.`,
        q43: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes tiene una percepción positiva. Por otra parte, un <strong>${p[2].toFixed(1)}%</strong> se mostró 'En desacuerdo' y el <strong>${p[3].toFixed(1)}%</strong> restante es 'Neutral', lo que puede indicar que el uso de lecciones aprendidas no es una práctica estandarizada.`,
        q44: (p) => `Las opiniones están divididas, con un <strong>${p[2].toFixed(1)}%</strong> 'En desacuerdo' y un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> positivo. El alto <strong>${p[3].toFixed(1)}%</strong> 'Neutral' inclina la balanza hacia una falta de visibilidad sobre la evaluación periódica de la eficacia de los controles.`,
        q45: (p) => `Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes muestra una percepción positiva. Por otro lado, un <strong>${p[2].toFixed(1)}%</strong> se expresa 'En desacuerdo'. El <strong>${p[3].toFixed(1)}%</strong> restante 'Neutral' puede indicar indiferencia o falta de conocimiento sobre la gestión de riesgos de terceros.`
    };

    function initializeDashboard() {
        populateFilters();
        setupEventListeners();
        renderAllTabs();
    }

    function setupEventListeners() {
        document.querySelectorAll('#analytics-section select').forEach(filter => filter.addEventListener('change', renderAllTabs));
        document.getElementById('comment-search').addEventListener('input', renderAllTabs);
        document.getElementById('question-selector').addEventListener('change', renderAllTabs);
        document.getElementById('tabs-nav').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                const targetTab = e.target.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(targetTab).classList.add('active');
            }
        });
    }
    
    function populateFilters() {
        const gerencias = ['Todos', ...new Set(allData.map(item => item.gerencia).filter(Boolean).sort())];
        const antiguedadRanges = ['Todos', '0-2 años', '2-5 años', '5-8 años', '10+ años'];
        const sexos = ['Todos', ...new Set(allData.map(item => item.sexo).filter(Boolean).sort())];
        
        document.getElementById('filter-gerencia').innerHTML = gerencias.map(g => `<option value="${g}">${g}</option>`).join('');
        document.getElementById('filter-antiguedad').innerHTML = antiguedadRanges.map(a => `<option value="${a}">${a}</option>`).join('');
        document.getElementById('filter-sexo').innerHTML = sexos.map(s => `<option value="${s}">${s}</option>`).join('');

        const questionSelector = document.getElementById('question-selector');
        questionSelector.innerHTML = Object.entries(questionLabels).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
    }

    function getFilteredData() {
        const selectedGerencia = document.getElementById('filter-gerencia').value;
        const selectedAntiguedad = document.getElementById('filter-antiguedad').value;
        const selectedSexo = document.getElementById('filter-sexo').value;
        
        return allData.filter(item => {
            const gerenciaMatch = selectedGerencia === 'Todos' || item.gerencia === selectedGerencia;
            const sexoMatch = selectedSexo === 'Todos' || item.sexo === selectedSexo;
            let antiguedadMatch = true;
            const antiguedad = parseInt(item.antiguedad, 10);
            if (!isNaN(antiguedad) && selectedAntiguedad !== 'Todos') {
                if (selectedAntiguedad === '0-2 años') antiguedadMatch = antiguedad <= 2;
                else if (selectedAntiguedad === '2-5 años') antiguedadMatch = antiguedad > 2 && antiguedad <= 5;
                else if (selectedAntiguedad === '5-8 años') antiguedadMatch = antiguedad > 5 && antiguedad <= 8;
                else if (selectedAntiguedad === '10+ años') antiguedadMatch = antiguedad >= 10;
            }
            return gerenciaMatch && sexoMatch && antiguedadMatch;
        });
    }

    function renderAllTabs() {
        const data = getFilteredData();
        const domainScores = calculateDomainScores(data);

        renderKPIs(data, domainScores);
        renderKpiRubric(data, domainScores);
        renderRadarChart(domainScores);
        renderRadarChartAnalysis(domainScores);
        renderPieChart(data);
        renderPieChartAnalysis(data);
        renderQuestionDetailChart(data);
        renderQuestionDetailAnalysis(data);
        renderCommentsTable(data);
        renderRawDataTable(data);
        renderHeatmap(data);
        renderRecommendations(domainScores);
        renderWordCloud(data);
    }
    
    function calculateDomainScores(data) {
        const domainScores = {};
        Object.keys(domainMapping).forEach(domain => {
            const { start, end } = domainMapping[domain];
            const scores = [];
            for (let i = start; i <= end; i++) {
                data.forEach(row => {
                    const score = parseInt(row[`q${i}`], 10);
                    if (!isNaN(score)) scores.push(score);
                });
            }
            domainScores[domain] = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
        });
        return domainScores;
    }

    function getAverageScore(data, questionKeys) {
        if (data.length === 0) return 0;
        const scores = [];
        questionKeys.forEach(key => {
            data.forEach(row => {
                const score = parseInt(row[key], 10);
                if (!isNaN(score)) scores.push(score);
            });
        });
        return scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
    }

    function renderKPIs(data, domainScores) {
        document.getElementById('kpi-total-respuestas').textContent = data.length;
        
        const allScores = Object.values(domainScores).filter(s => s > 0);
        const avgMaturity = allScores.length > 0 ? (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1) : '0.0';
        document.getElementById('kpi-madurez-promedio').textContent = `${avgMaturity}/5`;

        const sortedDomains = Object.entries(domainScores).sort((a, b) => b[1] - a[1]);
        document.getElementById('kpi-dominio-fuerte').textContent = sortedDomains.length > 0 && sortedDomains[0][1] > 0 ? sortedDomains[0][0] : 'N/A';
        
        const awarenessScore = getAverageScore(data, Object.keys(questionLabels).slice(28, 34)); // q32 a q37
        document.getElementById('kpi-awareness-level').textContent = `${(awarenessScore / 5 * 100).toFixed(0)}%`;

        const controlScore = getAverageScore(data, Object.keys(questionLabels).slice(34)); // q38 a q45
        document.getElementById('kpi-control-effectiveness').textContent = `${(controlScore / 5 * 100).toFixed(0)}%`;
    }
    
    function renderKpiRubric(data, domainScores) {
        const container = document.getElementById('kpi-rubric-text');
        if (data.length === 0) {
            container.innerHTML = "<p>No hay datos suficientes para generar la rúbrica.</p>";
            return;
        }

        const avgMaturity = parseFloat(document.getElementById('kpi-madurez-promedio').textContent);
        const awarenessLevel = parseInt(document.getElementById('kpi-awareness-level').textContent);
        const controlEffectiveness = parseInt(document.getElementById('kpi-control-effectiveness').textContent);
        const strongestDomain = document.getElementById('kpi-dominio-fuerte').textContent;

        const maturityText = `Un puntaje de <strong>Madurez General de ${avgMaturity}/5</strong> indica que la percepción de la cultura de seguridad se encuentra en un nivel <strong>${avgMaturity > 4 ? 'avanzado' : avgMaturity > 3 ? 'intermedio' : 'básico'}</strong>. Este valor representa el promedio de todos los dominios evaluados.`;
        const awarenessText = `El <strong>Nivel de Concienciación del ${awarenessLevel}%</strong> refleja la percepción de los empleados sobre la comunicación, capacitación y cultura de seguridad. Un valor alto sugiere que los mensajes y programas de concienciación son efectivos.`;
        const controlText = `La <strong>Eficacia de Controles del ${controlEffectiveness}%</strong> mide la percepción sobre el monitoreo, auditoría y mejora continua de los procesos de seguridad. Un porcentaje elevado indica confianza en los mecanismos de control existentes.`;
        const domainText = `El <strong>Dominio más Fuerte</strong> es <strong>'${strongestDomain}'</strong>, lo que señala que esta es el área mejor percibida por los encuestados y representa una fortaleza actual en la estrategia de seguridad de la información.`;
        
        container.innerHTML = `<p>${maturityText}</p><p>${awarenessText}</p><p>${controlText}</p><p>${domainText}</p>`;
    }


    function renderRadarChart(domainScores) {
        const ctx = document.getElementById('maturity-radar-chart').getContext('2d');
        if (charts.radar) charts.radar.destroy();
        charts.radar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: Object.keys(domainScores),
                datasets: [{
                    label: 'Nivel de Madurez', data: Object.values(domainScores),
                    backgroundColor: 'rgba(220, 38, 38, 0.2)', borderColor: 'rgba(220, 38, 38, 1)',
                    borderWidth: 2, pointBackgroundColor: 'rgba(220, 38, 38, 1)'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { angleLines: { color: 'rgba(0, 0, 0, 0.1)' }, grid: { color: 'rgba(0, 0, 0, 0.1)' }, pointLabels: { font: { size: 10 } }, suggestedMin: 0, suggestedMax: 5, ticks: { backdropColor: 'white', stepSize: 1 } } }
            }
        });
    }
    
    function renderRadarChartAnalysis(domainScores) {
        const container = document.getElementById('maturity-radar-analysis');
        const sortedDomains = Object.entries(domainScores).sort((a, b) => b[1] - a[1]);
        
        if (sortedDomains.length === 0 || sortedDomains[0][1] === 0) {
            container.innerHTML = "<p>No hay datos suficientes para analizar los dominios.</p>";
            return;
        }

        const strongest = sortedDomains[0];
        const weakest = sortedDomains[sortedDomains.length - 1];

        container.innerHTML = `<p>El análisis del gráfico de radar destaca las fortalezas y debilidades percibidas en la cultura de seguridad. El dominio <strong>'${strongest[0]}'</strong> es el mejor evaluado con un puntaje de <strong>${strongest[1].toFixed(1)}/5</strong>. Por otro lado, el área con mayor oportunidad de mejora es <strong>'${weakest[0]}'</strong>, con una puntuación de <strong>${weakest[1].toFixed(1)}/5</strong>.</p>`;
    }

    function renderPieChart(data) {
        const ctx = document.getElementById('gender-pie-chart').getContext('2d');
        const genderCounts = data.reduce((acc, item) => {
            const gender = item.sexo || "No especificado";
            acc[gender] = (acc[gender] || 0) + 1;
            return acc;
        }, {});
        if (charts.pie) charts.pie.destroy();
        charts.pie = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(genderCounts),
                datasets: [{ data: Object.values(genderCounts), backgroundColor: ['#ef4444', '#3b82f6', '#9ca3af', '#f97316', '#10b981'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderPieChartAnalysis(data) {
        const container = document.getElementById('gender-pie-analysis');
        if (data.length === 0) {
            container.innerHTML = "<p>No hay datos demográficos para analizar.</p>";
            return;
        }

        const genderCounts = data.reduce((acc, item) => {
            const gender = item.sexo || "No especificado";
            acc[gender] = (acc[gender] || 0) + 1;
            return acc;
        }, {});
        
        let analysisText = `El perfil demográfico de los <strong>${data.length}</strong> encuestados muestra la siguiente distribución: `;
        const entries = Object.entries(genderCounts);
        entries.forEach(([gender, count], index) => {
            const percentage = ((count / data.length) * 100).toFixed(1);
            analysisText += `<strong>${count}</strong> participantes (${percentage}%) se identifican como <strong>${gender}</strong>`;
            if (index < entries.length - 1) {
                analysisText += ', ';
            } else {
                analysisText += '.';
            }
        });
        container.innerHTML = `<p>${analysisText}</p>`;
    }

    function renderQuestionDetailChart(data) {
        const selectedQuestion = document.getElementById('question-selector').value;
        const ctx = document.getElementById('question-detail-chart').getContext('2d');
        const answerCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        data.forEach(row => {
            const answer = parseInt(row[selectedQuestion], 10);
            if (answer in answerCounts) answerCounts[answer]++;
        });
        if (charts.detail) charts.detail.destroy();
        charts.detail = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1: Totalmente en desacuerdo', '2: En desacuerdo', '3: Neutral', '4: De acuerdo', '5: Totalmente de acuerdo'],
                datasets: [{ label: 'Número de Respuestas', data: Object.values(answerCounts), backgroundColor: '#ef4444' }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }
    
    function renderQuestionDetailAnalysis(data) {
        const container = document.getElementById('question-detail-analysis');
        const selectedQuestionKey = document.getElementById('question-selector').value;

        if (data.length === 0) {
            container.innerHTML = "<p>No hay datos para analizar esta pregunta con los filtros actuales.</p>";
            return;
        }
        
        const scores = data.map(row => parseInt(row[selectedQuestionKey], 10)).filter(s => !isNaN(s));
        if (scores.length === 0) {
            container.innerHTML = "<p>No hay respuestas válidas para esta pregunta.</p>";
            return;
        }
        const answerLabels = ['Totalmente en desacuerdo', 'En desacuerdo', 'Neutral', 'De acuerdo', 'Totalmente de acuerdo'];
        const counts = scores.reduce((acc, score) => { acc[score] = (acc[score] || 0) + 1; return acc; }, {});
        
        const modeEntry = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
        const mode = modeEntry ? parseInt(modeEntry[0]) : null;
        const modeLabel = mode ? answerLabels[mode - 1] : "N/A";
        const modeCount = mode ? modeEntry[1] : 0;
        const modePercentage = ((modeCount / scores.length) * 100).toFixed(1);
        
        const percentages = {
            1: ((counts[1] || 0) / scores.length) * 100,
            2: ((counts[2] || 0) / scores.length) * 100,
            3: ((counts[3] || 0) / scores.length) * 100,
            4: ((counts[4] || 0) / scores.length) * 100,
            5: ((counts[5] || 0) / scores.length) * 100,
        };
        
        const interpretationFunction = expertInterpretations[selectedQuestionKey] || ((p) => `La distribución de respuestas muestra una tendencia clara. Un <strong>${(p[4] + p[5]).toFixed(1)}%</strong> de los participantes muestra una percepción positiva. Por otro lado, un <strong>${(p[1] + p[2]).toFixed(1)}%</strong> expresa desacuerdo. El <strong>${p[3].toFixed(1)}%</strong> restante se mantiene 'Neutral', lo que puede indicar indiferencia o falta de conocimiento.`);
        const specificInterpretation = interpretationFunction(percentages);

        container.innerHTML = `
            <p><strong>Respuesta más común:</strong> "${modeLabel}" (${modeCount} respuestas, ${modePercentage}%)</p>
            <hr class="my-3">
            <p class="text-base"><strong>Interpretación Técnica:</strong></p>
            <p>${specificInterpretation}</p>
        `;
    }
    
    function renderCommentsTable(data) {
        const tableBody = document.getElementById('comments-table-body');
        const searchTerm = document.getElementById('comment-search').value.toLowerCase();
        tableBody.innerHTML = '';
        let commentsFound = 0;
        data.forEach(row => {
            const comentario = row.q46_comentario || '';
            const mejora = row.q47_mejora || '';
            if ((comentario || mejora) && (comentario.toLowerCase().includes(searchTerm) || mejora.toLowerCase().includes(searchTerm))) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `<td class="px-6 py-4 whitespace-normal text-sm text-gray-700">${comentario}</td><td class="px-6 py-4 whitespace-normal text-sm text-gray-700">${mejora}</td>`;
                tableBody.appendChild(tr);
                commentsFound++;
            }
        });
        if(commentsFound === 0){
             tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4 text-gray-500">No hay comentarios que coincidan.</td></tr>';
        }
    }

    function renderRawDataTable(data) {
        const answerMap = {
            '1': '1-Totalmente en desacuerdo', '2': '2-En desacuerdo',
            '3': '3-Neutral', '4': '4-De acuerdo', '5': '5-Totalmente de acuerdo'
        };
        const tableHead = document.getElementById('raw-data-head');
        const tableBody = document.getElementById('raw-data-body');
        tableHead.innerHTML = ''; tableBody.innerHTML = '';
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td class="p-4 text-center text-gray-500" colspan="100%">No hay datos para los filtros actuales.</td></tr>';
            return;
        }
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.className = "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            th.textContent = header;
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            headers.forEach(header => {
                const td = document.createElement('td');
                td.className = "px-4 py-4 whitespace-nowrap text-sm text-gray-700";
                let cellValue = row[header];
                if (header.match(/^q\d+$/) && !header.includes('_comentario') && !header.includes('_mejora') && answerMap[cellValue]) {
                    cellValue = answerMap[cellValue];
                }
                td.textContent = cellValue;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }
    
    function renderHeatmap(data) {
        const likelihoodQs = ['q4','q5','q7','q9','q10','q12','q13','q18','q25','q26','q27','q31','q33','q35','q36','q37','q38','q39','q43','q44'];
        const impactQs = ['q6','q11','q15','q16','q19','q20','q28','q32','q42','q45'];
        
        const avgControlScore = getAverageScore(data, likelihoodQs);
        const likelihood = 5 - avgControlScore;
        const impact = getAverageScore(data, impactQs);
        
        const container = document.getElementById('heatmap-container');
        const levels = ['Bajo', 'Medio', 'Alto', 'Crítico'];
        const colors = [['#dcfce7', '#bbf7d0', '#fef08a', '#fca5a5'], ['#bbf7d0', '#86efac', '#facc15', '#ef4444'], ['#fef08a', '#facc15', '#eab308', '#dc2626'], ['#fca5a5', '#ef4444', '#dc2626', '#b91c1c']];
        
        let tableHtml = '<table class="heatmap-table"><tr><td></td>';
        levels.forEach(level => tableHtml += `<th class="font-normal text-sm p-1">${level}</th>`);
        tableHtml += '</tr>';

        for (let i = 3; i >= 0; i--) {
            tableHtml += `<tr><th class="font-normal text-sm text-right pr-2">${levels[i]}</th>`;
            for (let j = 0; j < 4; j++) {
                const isRiskCell = Math.floor(impact - 1) === i && Math.floor(likelihood - 1) === j;
                const marker = isRiskCell ? `<span title="Posición de Riesgo Actual: (Prob: ${likelihood.toFixed(1)}, Imp: ${impact.toFixed(1)})">●</span>` : '';
                tableHtml += `<td class="heatmap-cell" style="background-color: ${colors[i][j]};">${marker}</td>`;
            }
            tableHtml += '</tr>';
        }
        tableHtml += '</table>';
        
        container.innerHTML = `
            <div class="flex items-center">
                <div class="vertical-text font-semibold text-sm mr-2">IMPACTO</div>
                <div>
                    ${tableHtml}
                    <div class="text-center mt-2 text-sm font-semibold">PROBABILIDAD</div>
                </div>
            </div>
        `;
    }

    function renderRecommendations(domainScores) {
        const sortedDomains = Object.entries(domainScores).sort((a, b) => a[1] - b[1]);
        const container = document.getElementById('recommendations-container');
        container.innerHTML = '';
        
        const recommendationsMap = {
            "Conocimiento General de Políticas": "Reforzar la comunicación de las políticas existentes y crear campañas de concienciación sobre su importancia y contenido.",
            "Contexto organizacional y activos": "Iniciar un proyecto de clasificación de la información y asignación formal de propietarios a todos los activos críticos.",
            "Identificación de amenazas y vulnerabilidades": "Implementar un programa de gestión de vulnerabilidades, incluyendo escaneos periódicos y ejercicios de ethical hacking.",
            "Evaluación del riesgo": "Formalizar y documentar una metodología de evaluación de riesgos estándar para toda la organización, basada en probabilidad e impacto.",
            "Tratamiento del riesgo": "Establecer un comité de riesgos que revise y apruebe los planes de tratamiento, asegurando la asignación de presupuesto y responsables.",
            "Comunicación y concienciación": "Lanzar un programa de formación continua en seguridad, con simulaciones de phishing y módulos adaptados a cada rol.",
            "Monitoreo y mejora continua": "Desarrollar y monitorizar Indicadores Clave de Riesgo (KRIs) y realizar auditorías internas de seguridad de forma periódica."
        };
        let recommendationsFound = 0;
        for (let i = 0; i < 3; i++) {
            if (sortedDomains[i] && sortedDomains[i][1] < 3.5 && sortedDomains[i][1] > 0) {
                const [domain, score] = sortedDomains[i];
                const recommendation = recommendationsMap[domain] || "Revisar y fortalecer los controles y procesos asociados a este dominio.";
                const element = document.createElement('div');
                element.className = 'border-l-4 p-4 rounded-r-lg';
                const scoreColor = score < 2.5 ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50';
                element.innerHTML = `<div class="${scoreColor}">
                    <h4 class="font-bold">${i+1}. ${domain}</h4>
                    <p class="text-sm text-gray-700"><strong>Puntaje:</strong> ${score.toFixed(1)}/5</p>
                    <p class="mt-2 text-sm text-gray-800">${recommendation}</p>
                </div>`;
                container.appendChild(element);
                recommendationsFound++;
            }
        }
        if(recommendationsFound === 0) {
            container.innerHTML = '<div class="text-center p-4 bg-green-50 text-green-700 rounded-lg">¡Excelente! No se han identificado dominios con debilidades críticas que requieran acción inmediata.</div>';
        }
    }

    function renderWordCloud(data) {
        const text = data.map(row => `${row.q46_comentario || ''} ${row.q47_mejora || ''}`).join(' ');
        const stopWords = new Set(['de','la','que','el','en','y','a','los','del','las','un','por','con','no','una','su','para','es','al','lo','como','más','o','pero','sus','le','ha','me','si','sin','sobre','este','ya','entre','cuando','muy','también','hasta','desde','mi','porque','qué','solo','han','yo','está','uno','se','les','nos','son','tiene','hemos','sea','ser']);
        
        const wordCounts = {};
        text.toLowerCase().split(/\s+/).forEach(word => {
            word = word.replace(/[.,¡!¿?()]/g, '').trim();
            if (word && word.length > 2 && !stopWords.has(word) && isNaN(word)) {
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            }
        });
        
        const wordList = Object.entries(wordCounts).sort((a,b) => b[1] - a[1]).slice(0, 50).map(([text, weight]) => [text, weight * 2]);

        const canvas = document.getElementById('word-cloud-canvas');
        if (typeof WordCloud !== 'function') {
            console.error("WordCloud library is not loaded correctly.");
            canvas.getContext('2d').fillText("Error al cargar librería de Nube de Palabras.", 10, 50);
            return;
        }

        if(wordList.length > 1) {
            WordCloud(canvas, { list: wordList, backgroundColor: 'transparent', weightFactor: 2, shrinkToFit: true, color: 'random-dark' });
        } else {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "16px Roboto";
            ctx.fillStyle = "#6b7280";
            ctx.textAlign = "center";
            ctx.fillText("No hay suficientes comentarios para generar la nube.", canvas.width/2, canvas.height/2);
        }
    }

    document.getElementById('export-pdf-btn').addEventListener('click', () => {
        if (!allData.length) return;
        
        if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
            alert("Error: Librerías para exportar a PDF no cargaron. Recargue la página.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const activeTab = document.querySelector('.tab-content.active');
        if (!activeTab) return;

        const pdfTitle = `Reporte de Riesgos - ${document.querySelector('.tab-button.active').textContent.trim()}`;
        
        loadingText.textContent = 'Generando PDF, por favor espere...';
        loadingContainer.classList.remove('hidden');
        analyticsSection.classList.add('hidden');
        
        // Temporarily disable chart animations for consistent rendering
        if (window.Chart && Chart.defaults) {
            Chart.defaults.animation = false;
        }
        Object.values(charts).forEach(chart => {
            if (chart && typeof chart.update === 'function') {
                chart.update('none');
            }
        });

        setTimeout(() => {
            html2canvas(activeTab, { scale: 1.5, useCORS: true }).then(canvas => {
                try {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgHeight = canvas.height * pdfWidth / canvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 15; // Initial top margin for content
                    
                    pdf.setFontSize(16);
                    pdf.text(pdfTitle, 10, 10);
                    
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= (pageHeight - position);

                    while (heightLeft > 0) {
                        position -= pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`reporte_analisis_riesgos-${new Date().toISOString().slice(0,10)}.pdf`);
                } catch (e) {
                    console.error("Error al crear el PDF:", e);
                    alert("Ocurrió un error al crear el PDF.");
                } finally {
                    // Re-enable animations
                    if (window.Chart && Chart.defaults) {
                        Chart.defaults.animation = true;
                    }
                     Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.update === 'function') {
                            chart.update();
                        }
                    });
                    loadingContainer.classList.add('hidden');
                    analyticsSection.classList.remove('hidden');
                }
            }).catch(error => {
                console.error('Error con html2canvas:', error);
                alert("Error al capturar la imagen del reporte.");
                if (window.Chart && Chart.defaults) {
                    Chart.defaults.animation = true;
                }
                 Object.values(charts).forEach(chart => {
                    if (chart && typeof chart.update === 'function') {
                        chart.update();
                    }
                });
                loadingContainer.classList.add('hidden');
                analyticsSection.classList.remove('hidden');
            });
        }, 500);
    });

</script>
</body>
</html>

